# 实验4：ZJU-I 型机械臂解析逆运动学报告

## 实验目标
- 推导桌面机械臂的解析逆运动学求解流程，明确各关节角与末端位姿之间的几何关系。
- 针对 6 组典型末端位姿，求解一组自洽的关节角解，并在 CoppeliaSim 中验证位置与姿态误差。
- 利用 `uv` 统一环境，沉淀可复现实验流程与运行日志。

## DH 参数与符号约定
采用标准 DH 约定，单位为毫米 / 弧度。关节变量记为 $\theta_i$，并在实现中通过常量偏置吸收固定角度。

| 关节 $i$ | $a_i$ | $\alpha_i$ | $d_i$ | $\theta_i$ (含偏置) |
| --- | --- | --- | --- | --- |
| 1 | 0 | $-\pi/2$ | 230 | $\theta_1$ |
| 2 | 185 | $0$ | -54 | $\theta_2 - \pi/2$ |
| 3 | 170 | $0$ | 0 | $\theta_3$ |
| 4 | 0 | $\pi/2$ | 77 | $\theta_4 + \pi/2$ |
| 5 | 0 | $\pi/2$ | 77 | $\theta_5 + \pi/2$ |
| 6 | 0 | 0 | 85.5 | $\theta_6$ |

记工具末端齐次变换为
$$
T_{06} =
\begin{bmatrix}
R_{06} & p_{06} \\
0 & 1
\end{bmatrix},
$$
其中 $R_{06}\in SO(3)$，$p_{06}=[x\ y\ z]^\top$。

## 解析逆运动学推导
### 腕部解耦
由于 $a_4 = a_5 = a_6 = 0$，关节 4–6 的转轴共点，末端位姿可拆分为腕部姿态与前臂位置两部分。设单位向量 $\hat{z} = [0,0,1]^\top$，则腕心（ wrist center ）坐标为
$$
p_w = p_{06} - d_6 R_{06}\hat{z} - d_5 R_{06}R_{65}\hat{z} - d_4 R_{06}R_{65}R_{54}\hat{z}.
$$
当忽略 $d_4$、$d_5$ 导致的微小耦合时，上式可退化为常见的 $p_w \approx p_{06} - d_6 R_{06}\hat{z}$，并以此构造几何初值；本项目中的 `solve_ik_nsolve` 例程随后用 SymPy `nsolve` 对该初值进行修正，确保满足完整 DH 模型。

### 关节 1–3 的几何求解
1. **基座关节**：将腕心投影至底座平面，得到
   $$
   q_1 = \operatorname{atan2}(p_{w,y},\ p_{w,x}),
   $$
   并存在 $q_1 + \pi$ 的镜像分支（右手 / 左手配置）。
2. **肩肘平面化**：将腕心转换到关节 2 的平面坐标系
   $$
   p'_w = R_z(-q_1)\left(p_w - [0,0,d_1]^\top\right),
   $$
   同时考虑关节 2 的偏距 $d_2=-54$。
   记
   $$
   r = \sqrt{(p'_{w,x})^2 + (p'_{w,y} - d_2)^2},\quad
   s = p'_{w,z}.
   $$
3. **肘关节**：基于余弦定理，关节 3 的弯折量满足
   $$
   \cos q_3 = \frac{r^2 + s^2 - a_2^2 - a_3^2}{2 a_2 a_3},
   $$
   并对应 “肘上 / 肘下” 两种符号分支
   $$
   q_3 = \operatorname{atan2}\left(\pm \sqrt{1-\cos^2 q_3},\ \cos q_3\right).
   $$
4. **肩关节**：利用平面三角形再次应用正弦定理
   $$
   q_2 = \operatorname{atan2}(s,\ r) - \operatorname{atan2}\left(a_3\sin q_3,\ a_2 + a_3\cos q_3\right).
   $$

### 关节 4–6 的姿态求解
已知 $R_{03}$ 可由 $q_1,q_2,q_3$ 直接求得，腕部姿态解耦为
$$
R_{36} = R_{03}^\top R_{06}.
$$
结合 DH 建模可写出
$$
R_{36} = R_z(q_4 + \tfrac{\pi}{2})\,R_x(\tfrac{\pi}{2})\,R_z(q_5 + \tfrac{\pi}{2})\,R_x(\tfrac{\pi}{2})\,R_z(q_6),
$$
其具体分量满足：
$$
\begin{aligned}
\sin q_5 &= R_{36}(3,3), \\\\
\cos q_5 &= \sqrt{R_{36}(1,3)^2 + R_{36}(2,3)^2}, \\\\
q_4 &= \operatorname{atan2}\big(R_{36}(2,3),\ -R_{36}(1,3)\big), \\\\
q_6 &= \operatorname{atan2}\big(-R_{36}(3,2),\ R_{36}(3,1)\big).
\end{aligned}
$$
当 $\cos q_5 \approx 0$ 时（腕部奇异），设置 $q_4 = 0$，并将剩余转角吸收到 $q_6$。

### 分支与奇异性分析
- **分支**：$q_1$ 有左右臂两解；$q_3$ 对应肘上 / 肘下；腕部当 $\cos q_5 \neq 0$ 时存在 $q_5$ 取 $\pm$ 的镜像，再由 $q_4,q_6$ 调整。组合后最多产生 $2\times 2 \times 2 = 8$ 组解析解。
- **基座奇异**：$\rho = \sqrt{p_{w,x}^2 + p_{w,y}^2} \to 0$ 时，$q_1$ 未定义，需要采用任务空间约束或数值 IK。
- **肘奇异**：$\cos q_3 = \pm 1$ 对应腕心位于两连杆完全伸直 / 折叠位置，法向敏感，应避免作为运行点。
- **腕部奇异**：$q_5 \to 0$ 或 $\pi$ 时，$q_4$ 与 $q_6$ 失去独立性；在 CLI 中通过约束解的选择并可借助 `--nsolve` 细化。

## 实验结果
`report/lab4/requirements.md` 中给出的五组末端位姿与其关节解记录如下（数值来自 CLI `ik euler` 与 `scripts/verify_cases.py`，误差基于仿真结果 `report/lab4/verification_results.log`）：

| Case | Target (m, rad) | q (rad) | q (deg) | Pos err (mm) | Rot err (deg) |
| --- | --- | --- | --- | --- | --- |
| 1 | (0.117, 0.334, 0.499, -2.019, -0.058, -2.190) | `[1.046916, 0.543234, 0.531454, -0.551512, 0.523909, 0.698541]` | `[59.984, 31.125, 30.450, -31.599, 30.018, 40.023]` | 0.019679 | 0.000041 |
| 2 | (-0.066, 0.339, 0.444, -2.618, -0.524, -3.141) | `[1.571526, 0.460517, 0.660834, -0.074512, 0.523635, 0.001322]` | `[90.042, 26.386, 37.863, -4.269, 30.002, 0.076]` | 0.019849 | 0.000021 |
| 3 | (0.300, 0.250, 0.260, -2.640, 0.590, -2.350) | `[-2.364871, -0.787570, -1.345606, 1.310991, 3.036375, 0.111535]` | `[-135.497, -45.124, -77.098, 75.114, 173.971, 6.390]` | 0.019876 | 0.000054 |
| 4 | (0.420, 0.000, 0.360, 3.140, 1.000, -1.570) | `[-0.065918, 0.827356, 0.824529, -1.080132, 0.054597, -0.036195]` | `[-3.777, 47.404, 47.242, -61.887, 3.128, -2.074]` | 0.019599 | 0.000081 |
| 5 | (0.320, -0.250, 0.160, 3.000, 0.265, -0.840) | `[-0.735652, 1.102509, 1.053207, -0.875362, 0.074856, -0.012805]` | `[-42.150, 63.169, 60.344, -50.155, 4.289, -0.734]` | 0.019678 | 0.000062 |

为便于复核，同步保存 `report/lab4/ik_solutions.csv`，包含目标位姿、关节角（弧度 / 角度）与仿真误差。

## 复现实验步骤
1. 环境：`uv.exe sync`
2. 求解单个末端位姿（位置默认米，角度弧度；如输入为毫米 / 度加 `--pos-unit mm --deg`）：
   ```ps1
   uv.exe run myarm -- ik euler --target 0.117 0.334 0.499 -2.019 -0.058 -2.190 --pos-unit m
   ```
   可追加 `--nsolve` 调用 `solve_ik_nsolve` 以符号式精修。
3. 批量验证（需启用 CoppeliaSim ZMQ 服务）：
   ```ps1
   uv.exe run python scripts/verify_cases.py
   ```
4. 检查 `report/lab4/verification_results.log` 获取位置 / 姿态误差。
